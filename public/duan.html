<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Upload folder + Auth</title>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-storage.js"></script>
    <style>
        body {
            font-family: Arial;
            padding: 30px;
        }

        #drop-zone {
            border: 3px dashed #aaa;
            padding: 40px;
            text-align: center;
            margin-top: 20px;
            background: #f9f9f9;
        }

        #drop-zone.highlight {
            background: #e0f7fa;
        }

        #log {
            white-space: pre-wrap;
            background: #eee;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            height: 250px;
            overflow-y: auto;
        }

        input {
            padding: 8px;
            margin: 5px 0;
            width: 200px;
        }

        button {
            padding: 8px 12px;
            margin: 5px;
        }

        .auth-box {
            margin-bottom: 20px;
        }
    </style>
</head>

<body>

    <h2>ğŸ”¥ Upload Folder sau khi ÄÄƒng Nháº­p</h2>

    <div class="auth-box">
        <input type="email" id="email" placeholder="Email"><br>
        <input type="password" id="password" placeholder="Máº­t kháº©u"><br>
        <button onclick="login()">ÄÄƒng nháº­p</button>
        <button onclick="register()">ÄÄƒng kÃ½</button>
        <button onclick="logout()">ÄÄƒng xuáº¥t</button>
        <div id="auth-status">âš ï¸ ChÆ°a Ä‘Äƒng nháº­p</div>
    </div>

    <div id="drop-zone">
        <strong>KÃ©o thÆ° má»¥c vÃ o Ä‘Ã¢y</strong><br>
        (Chá»‰ hoáº¡t Ä‘á»™ng náº¿u Ä‘Ã£ Ä‘Äƒng nháº­p)
    </div>

    <div id="log"></div>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBVWwk5WYkOOFjYReBQNiqVmJDOzLlJX34",
            authDomain: "blogthanhduy.firebaseapp.com",
            projectId: "blogthanhduy",
            storageBucket: "blogthanhduy.appspot.com",
            messagingSenderId: "346123189563",
            appId: "1:346123189563:web:bd8a38044b8295e8a0cb1e"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const storageRef = firebase.storage().ref();

        let currentUser = null;

        const dropZone = document.getElementById("drop-zone");
        const log = document.getElementById("log");
        const status = document.getElementById("auth-status");

        function logMessage(msg) {
            log.textContent += msg + "\n";
        }

        // Xá»­ lÃ½ auth state
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                status.textContent = "âœ… ÄÃ£ Ä‘Äƒng nháº­p: " + user.email;
            } else {
                currentUser = null;
                status.textContent = "âš ï¸ ChÆ°a Ä‘Äƒng nháº­p";
            }
        });

        // ÄÄƒng nháº­p
        function login() {
            const email = document.getElementById("email").value.trim();
            const password = document.getElementById("password").value.trim();
            if (!email || !password) return alert("Nháº­p Ä‘áº§y Ä‘á»§ email vÃ  máº­t kháº©u!");

            auth.signInWithEmailAndPassword(email, password)
                .then(() => logMessage("âœ… ÄÄƒng nháº­p thÃ nh cÃ´ng!"))
                .catch(err => alert("âŒ Lá»—i: " + err.message));
        }

        // ÄÄƒng kÃ½
        // function register() {
        //   const email = document.getElementById("email").value.trim();
        //   const password = document.getElementById("password").value.trim();
        //   if (!email || !password) return alert("Nháº­p Ä‘áº§y Ä‘á»§ email vÃ  máº­t kháº©u!");

        //   auth.createUserWithEmailAndPassword(email, password)
        //     .then(() => logMessage("âœ… Táº¡o tÃ i khoáº£n thÃ nh cÃ´ng!"))
        //     .catch(err => alert("âŒ Lá»—i: " + err.message));
        // }

        // ÄÄƒng xuáº¥t
        function logout() {
            auth.signOut();
            logMessage("ğŸšª ÄÃ£ Ä‘Äƒng xuáº¥t.");
        }

        // KÃ©o tháº£ folder
        dropZone.addEventListener("dragover", (e) => {
            e.preventDefault();
            dropZone.classList.add("highlight");
        });

        dropZone.addEventListener("dragleave", () => {
            dropZone.classList.remove("highlight");
        });

        dropZone.addEventListener("drop", (e) => {
            e.preventDefault();
            dropZone.classList.remove("highlight");

            if (!currentUser) {
                alert("âš ï¸ Báº¡n cáº§n Ä‘Äƒng nháº­p trÆ°á»›c khi upload!");
                return;
            }

            const items = e.dataTransfer.items;
            if (!items || !items[0].webkitGetAsEntry) {
                alert("âš ï¸ TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ kÃ©o-tháº£ folder!");
                return;
            }

            for (let i = 0; i < items.length; i++) {
                const item = items[i].webkitGetAsEntry();
                if (item) {
                    traverseFileTree(item);
                }
            }
        });

        function traverseFileTree(item, path = "") {
            if (item.isFile) {
                item.file((file) => {
                    const fullPath = path + file.name;
                    uploadFileToFirebase(file, fullPath);
                });
            } else if (item.isDirectory) {
                const dirReader = item.createReader();
                dirReader.readEntries((entries) => {
                    for (let i = 0; i < entries.length; i++) {
                        traverseFileTree(entries[i], path + item.name + "/");
                    }
                });
            }
        }

        function uploadFileToFirebase(file, fullPath) {
            const fileRef = storageRef.child("uploads/" + fullPath);
            fileRef.put(file)
                .then(() => {
                    logMessage("âœ… Upload: " + fullPath);
                })
                .catch((err) => {
                    logMessage("âŒ Lá»—i upload: " + fullPath + " - " + err.message);
                });
        }
    </script>
</body>

</html>