<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Upload folder + Auth</title>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-storage.js"></script>
    <style>
        body {
            font-family: Arial;
            padding: 30px;
        }

        #drop-zone {
            border: 3px dashed #aaa;
            padding: 40px;
            text-align: center;
            margin-top: 20px;
            background: #f9f9f9;
        }

        #drop-zone.highlight {
            background: #e0f7fa;
        }

        #log {
            white-space: pre-wrap;
            background: #eee;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            height: 250px;
            overflow-y: auto;
        }

        input {
            padding: 8px;
            margin: 5px 0;
            width: 200px;
        }

        button {
            padding: 8px 12px;
            margin: 5px;
        }

        .auth-box {
            margin-bottom: 20px;
        }
    </style>
</head>

<body>

    <h2>🔥 Upload Folder sau khi Đăng Nhập</h2>

    <div class="auth-box">
        <input type="email" id="email" placeholder="Email"><br>
        <input type="password" id="password" placeholder="Mật khẩu"><br>
        <button onclick="login()">Đăng nhập</button>
        <button onclick="register()">Đăng ký</button>
        <button onclick="logout()">Đăng xuất</button>
        <div id="auth-status">⚠️ Chưa đăng nhập</div>
    </div>

    <div id="drop-zone">
        <strong>Kéo thư mục vào đây</strong><br>
        (Chỉ hoạt động nếu đã đăng nhập)
    </div>

    <div id="log"></div>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBVWwk5WYkOOFjYReBQNiqVmJDOzLlJX34",
            authDomain: "blogthanhduy.firebaseapp.com",
            projectId: "blogthanhduy",
            storageBucket: "blogthanhduy.appspot.com",
            messagingSenderId: "346123189563",
            appId: "1:346123189563:web:bd8a38044b8295e8a0cb1e"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const storageRef = firebase.storage().ref();

        let currentUser = null;

        const dropZone = document.getElementById("drop-zone");
        const log = document.getElementById("log");
        const status = document.getElementById("auth-status");

        function logMessage(msg) {
            log.textContent += msg + "\n";
        }

        // Xử lý auth state
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                status.textContent = "✅ Đã đăng nhập: " + user.email;
            } else {
                currentUser = null;
                status.textContent = "⚠️ Chưa đăng nhập";
            }
        });

        // Đăng nhập
        function login() {
            const email = document.getElementById("email").value.trim();
            const password = document.getElementById("password").value.trim();
            if (!email || !password) return alert("Nhập đầy đủ email và mật khẩu!");

            auth.signInWithEmailAndPassword(email, password)
                .then(() => logMessage("✅ Đăng nhập thành công!"))
                .catch(err => alert("❌ Lỗi: " + err.message));
        }

        // Đăng ký
        // function register() {
        //   const email = document.getElementById("email").value.trim();
        //   const password = document.getElementById("password").value.trim();
        //   if (!email || !password) return alert("Nhập đầy đủ email và mật khẩu!");

        //   auth.createUserWithEmailAndPassword(email, password)
        //     .then(() => logMessage("✅ Tạo tài khoản thành công!"))
        //     .catch(err => alert("❌ Lỗi: " + err.message));
        // }

        // Đăng xuất
        function logout() {
            auth.signOut();
            logMessage("🚪 Đã đăng xuất.");
        }

        // Kéo thả folder
        dropZone.addEventListener("dragover", (e) => {
            e.preventDefault();
            dropZone.classList.add("highlight");
        });

        dropZone.addEventListener("dragleave", () => {
            dropZone.classList.remove("highlight");
        });

        dropZone.addEventListener("drop", (e) => {
            e.preventDefault();
            dropZone.classList.remove("highlight");

            if (!currentUser) {
                alert("⚠️ Bạn cần đăng nhập trước khi upload!");
                return;
            }

            const items = e.dataTransfer.items;
            if (!items || !items[0].webkitGetAsEntry) {
                alert("⚠️ Trình duyệt không hỗ trợ kéo-thả folder!");
                return;
            }

            for (let i = 0; i < items.length; i++) {
                const item = items[i].webkitGetAsEntry();
                if (item) {
                    traverseFileTree(item);
                }
            }
        });

        function traverseFileTree(item, path = "") {
            if (item.isFile) {
                item.file((file) => {
                    const fullPath = path + file.name;
                    uploadFileToFirebase(file, fullPath);
                });
            } else if (item.isDirectory) {
                const dirReader = item.createReader();
                dirReader.readEntries((entries) => {
                    for (let i = 0; i < entries.length; i++) {
                        traverseFileTree(entries[i], path + item.name + "/");
                    }
                });
            }
        }

        function uploadFileToFirebase(file, fullPath) {
            const fileRef = storageRef.child("uploads/" + fullPath);
            fileRef.put(file)
                .then(() => {
                    logMessage("✅ Upload: " + fullPath);
                })
                .catch((err) => {
                    logMessage("❌ Lỗi upload: " + fullPath + " - " + err.message);
                });
        }
    </script>
</body>

</html>